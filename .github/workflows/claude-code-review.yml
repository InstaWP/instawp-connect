name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'
    
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # Optional: Specify model (defaults to Claude Sonnet 4, uncomment for Claude Opus 4)
          # model: "claude-opus-4-20250514"
          
          # Direct prompt for automated review (no @claude mention needed)
          direct_prompt: |
            Please review this pull request for InstaWP Connect WordPress plugin.

            **CRITICAL ARCHITECTURAL PRINCIPLES TO ENFORCE:**

            1. **Data Layer Abstraction** - Handle data at its storage layer (options), NOT at its semantic layer (widgets, theme mods, etc.)
               - Work directly with wp_options table or underlying storage
               - Avoid high-level WordPress APIs that might miss data
               - Ensure complete data capture without abstraction limitations

            2. **DRY (Don't Repeat Yourself)** - Eliminate code duplication through proper abstraction
               - Check for duplicated code that should be extracted into shared functions
               - Consolidate similar patterns into reusable utilities

            3. **SSOT (Single Source of Truth)** - One authoritative source for each piece of data
               - Avoid data duplication across multiple locations
               - Ensure clear, unidirectional data flow

            4. **SoC (Separation of Concerns)** - Keep different responsibilities properly separated
               - Business logic separate from data access logic
               - Concerns isolated in focused, single-purpose modules

            5. **Proper Abstraction** - Core-level implementation to enforce above principles
               - Build core utility functions for reuse across features
               - Abstractions at the right level (not too high, not too low)

            **ALSO REVIEW FOR:**
            - Code quality and best practices
              * WordPress Coding Standards (tabs, snake_case with instawp_/iwp_ prefix, PHPDoc)
              * Clean, readable, and maintainable code
              * Proper use of WordPress APIs and functions
            - Potential bugs or issues
              * Logic errors and edge cases
              * Null/undefined handling
              * Race conditions or timing issues
              * Error-prone patterns
            - Security concerns
              * Input sanitization and validation
              * SQL injection prevention (prepared statements)
              * XSS prevention (escaped output)
              * CSRF protection where applicable
              * Secure data handling and storage
            - Performance considerations
              * Minimize database queries
              * Efficient algorithms and data structures
              * Memory usage (critical for large migrations)
              * Avoid unnecessary loops and operations
              * Proper caching strategies
            - Test coverage
              * Are critical paths tested?
              * Edge cases covered?
              * Regression test considerations
              * Manual testing requirements
            - Backward compatibility (no breaking changes, graceful deprecation)
            - Proper error handling with meaningful messages
            - Works in standalone mode (migration scripts run WITHOUT WordPress context)

            **COMMON ANTI-PATTERNS TO FLAG:**
            - Working with semantic layer (widgets API) instead of storage layer (options table)
            - Code duplication instead of extracting reusable functions
            - Data redundancy (storing same data in multiple places)
            - Mixed concerns (business logic mixed with data access)
            - File system reliance (unreliable on shared hosting)
            - Assuming WordPress is loaded in migration scripts

            Be constructive and helpful in your feedback.

          # Optional: Use sticky comments to make Claude reuse the same comment on subsequent pushes to the same PR
          # use_sticky_comment: true
          
          # Optional: Customize review based on file types
          # direct_prompt: |
          #   Review this PR focusing on:
          #   - For TypeScript files: Type safety and proper interface usage
          #   - For API endpoints: Security, input validation, and error handling
          #   - For React components: Performance, accessibility, and best practices
          #   - For tests: Coverage, edge cases, and test quality
          
          # Optional: Different prompts for different authors
          # direct_prompt: |
          #   ${{ github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR' && 
          #   'Welcome! Please review this PR from a first-time contributor. Be encouraging and provide detailed explanations for any suggestions.' ||
          #   'Please provide a thorough code review focusing on our coding standards and best practices.' }}
          
          # Optional: Add specific tools for running tests or linting
          # allowed_tools: "Bash(npm run test),Bash(npm run lint),Bash(npm run typecheck)"
          
          # Optional: Skip review for certain conditions
          # if: |
          #   !contains(github.event.pull_request.title, '[skip-review]') &&
          #   !contains(github.event.pull_request.title, '[WIP]')

